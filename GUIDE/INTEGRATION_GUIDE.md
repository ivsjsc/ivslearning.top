# ðŸš€ Backend API Integration Guide

## Má»¥c lá»¥c
1. [Thiáº¿t láº­p](#thiáº¿t-láº­p)
2. [API Client Examples](#api-client-examples)
3. [Rate Limiting & Caching](#rate-limiting--caching)
4. [Error Handling](#error-handling)
5. [Best Practices](#best-practices)
6. [Troubleshooting](#troubleshooting)

---

## Thiáº¿t láº­p

### 1. CÃ i Ä‘áº·t API Client SDK

#### Cho Node.js / Deno Projects
```typescript
// Copy file api-client.ts, backend-service.ts, advanced-backend-service.ts
// vÃ o project cá»§a báº¡n

import { AdvancedBackendService } from './lib/advanced-backend-service';

const backendService = new AdvancedBackendService({
  baseUrl: 'https://your-backend-url.com',
  rateLimitConfig: {
    maxRequests: 100,
    windowMs: 60000, // 1 minute
    perEndpoint: true,
  },
  cacheConfig: {
    maxSize: 100,
    defaultTtl: 5 * 60 * 1000, // 5 minutes
    enableCaching: true,
  },
});
```

#### Cho Browser / React Projects
```typescript
// src/services/api.ts
import { AdvancedBackendService } from '@/lib/advanced-backend-service';

export const api = new AdvancedBackendService({
  baseUrl: process.env.REACT_APP_BACKEND_URL,
  cacheConfig: { enableCaching: true },
});

// Khi user login, set token
export function setApiToken(token: string) {
  api.setAuthToken(token);
}
```

---

## API Client Examples

### ðŸ“Œ Láº¥y User Profile

```typescript
// Basic usage
try {
  const profile = await backendService.getUserProfile('user-id-123');
  console.log('User:', profile.displayName);
  console.log('Role:', profile.role);
} catch (error) {
  console.error('Failed to fetch user:', error.message);
}
```

**Response:**
```json
{
  "id": "user-123",
  "email": "user@example.com",
  "displayName": "John Doe",
  "role": "teacher",
  "claims": {
    "custom_claim": "value"
  },
  "metadata": {
    "createdAt": "2025-01-01T00:00:00Z",
    "lastSignInAt": "2025-11-08T10:30:00Z"
  },
  "firestore": {
    "avatarUrl": "...",
    "department": "..."
  }
}
```

---

### ðŸ“Œ Láº¥y Posts

```typescript
// Get all posts
const posts = await backendService.getPosts();

// Get posts with filters
const myPosts = await backendService.getPostsByAuthor('user-123');

// Advanced filtering
const posts = await backendService.getPosts({
  filters: [
    { field: 'authorId', op: '==', value: 'user-123' },
    { field: 'clientSource', op: '==', value: 'web' },
  ],
  limit: 20,
  orderBy: {
    field: 'createdAt',
    direction: 'desc',
  },
});

console.log(`Fetched ${posts.length} posts`);
posts.forEach(post => {
  console.log(`${post.authorName}: ${post.content.substring(0, 50)}...`);
});
```

**Filter Operators:**
```
'==' | '!=' | '<' | '<=' | '>' | '>=' | 
'array-contains' | 'array-contains-any' | 'in' | 'not-in'
```

---

### ðŸ“Œ Táº¡o Content GiÃ¡o dá»¥c

```typescript
const content = await backendService.generateContent({
  topic: 'Present Perfect Tense',
  vocabulary: ['have', 'has', 'yet', 'already', 'just'],
  grammar: 'Uses of Present Perfect',
});

console.log('Quiz:', content.quiz);
console.log('Dialogue:', content.dialogue);
console.log('Generated by:', content.modelUsed); // 'gemini', 'openai', etc.
```

---

### ðŸ“Œ Kiá»ƒm tra Admin Override

```typescript
const result = await backendService.checkAdminOverride(
  'user-123',
  'delete_any_post'
);

if (result.canOverride) {
  console.log('âœ“ Admin can perform this action');
} else {
  console.log('âœ— Not allowed');
}
```

---

## Rate Limiting & Caching

### ðŸ”’ Rate Limiting

Há»‡ thá»‘ng tá»± Ä‘á»™ng giá»›i háº¡n sá»‘ request:

```typescript
// Check remaining tokens
const status = backendService.getRateLimiterStatus('/posts');
console.log(`Remaining requests: ${status.remaining}/100`);

// Auto-retry vá»›i exponential backoff
// KhÃ´ng cáº§n xá»­ lÃ½ thá»§ cÃ´ng, client tá»± Ä‘á»™ng xá»­ lÃ½
```

**Config máº·c Ä‘á»‹nh:**
- 100 requests/minute (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh)
- Per-endpoint limiting
- Automatic retry vá»›i exponential backoff

---

### ðŸ’¾ Caching

Reduce load vÃ  latency:

```typescript
// Automatically cached for 5 minutes
const posts = await backendService.getPosts();
console.log('[First call] Fetched from API');

const posts2 = await backendService.getPosts();
console.log('[Second call] Loaded from cache');

// Invalidate cache khi cáº§n
backendService.invalidateCache('/posts');

// Check cache stats
const stats = backendService.getCacheStats();
console.log('Cache entries:', stats.entries);

// Clear all cache
backendService.clearCache();
```

**TTL máº·c Ä‘á»‹nh:**
- User profiles: 10 minutes
- Posts: 5 minutes
- Custom content: Real-time (no cache)

---

## Error Handling

### âœ… Proper Error Handling

```typescript
import { ApiError } from './lib/api-client';

async function fetchUserSafely(userId: string) {
  try {
    const user = await backendService.getUserProfile(userId);
    return user;
  } catch (error) {
    if (error instanceof ApiError) {
      switch (error.status) {
        case 404:
          console.error('User not found');
          break;
        case 401:
          console.error('Unauthorized - token may be expired');
          // Redirect to login
          break;
        case 429:
          console.error('Too many requests - rate limited');
          break;
        case 500:
          console.error('Server error - retrying...');
          break;
        default:
          console.error(`API Error (${error.status}): ${error.message}`);
      }
      
      // Access additional details
      console.error('Details:', error.details);
    } else if (error instanceof TypeError) {
      console.error('Network error:', error.message);
    } else {
      console.error('Unknown error:', error);
    }
  }
}
```

---

### ðŸ“Š Circuit Breaker Pattern

Tá»± Ä‘á»™ng ngá»«ng gá»i API khi backend gáº·p sá»± cá»‘:

```typescript
const status = backendService.getCircuitBreakerStatus();
console.log('Circuit state:', status.state); // 'closed', 'open', 'half-open'
console.log('Failures:', status.failures);

// States:
// - CLOSED: Normal operation
// - OPEN: Rejecting requests (backend down)
// - HALF_OPEN: Testing recovery
```

---

## Best Practices

### âœ… Do's

```typescript
// âœ“ Use async/await
async function loadData() {
  const posts = await backendService.getPosts();
}

// âœ“ Set auth token after login
firebase.auth().onAuthStateChanged(async user => {
  if (user) {
    const token = await user.getIdToken();
    backendService.setAuthToken(token);
  }
});

// âœ“ Use specific queries (reduce data transfer)
const userPosts = await backendService.getPostsByAuthor(userId, 10);

// âœ“ Handle errors gracefully
try {
  const data = await backendService.getPosts();
} catch (error) {
  // Show error to user
  showNotification('Failed to load posts', 'error');
}

// âœ“ Check rate limiter before heavy operations
const limiterStatus = backendService.getRateLimiterStatus();
if (limiterStatus.remaining < 10) {
  console.warn('Approaching rate limit');
}
```

### âŒ Don'ts

```typescript
// âœ— Don't ignore errors
const posts = await backendService.getPosts(); // No error handling

// âœ— Don't make redundant calls
for (let i = 0; i < 100; i++) {
  await backendService.getPosts(); // Spam API
}

// âœ— Don't share API clients between apps
const api1 = new AdvancedBackendService({...});
const api2 = new AdvancedBackendService({...}); // Create separate instances

// âœ— Don't bypass rate limiter
const client = new ApiClient({...});
await client.post('/api/ai-router', {...}); // Skip limiter

// âœ— Don't store sensitive data in cache
// Cache only reads; never cache passwords/tokens
```

---

## Troubleshooting

### ðŸ”§ Káº¿t ná»‘i bá»‹ timeout

```typescript
// TÄƒng timeout
const api = new AdvancedBackendService({
  baseUrl: 'https://...',
  // timeout máº·c Ä‘á»‹nh: 30000ms
  // CÃ³ thá»ƒ tÃ¹y chá»‰nh trong ApiClient config
});

// Check network
console.log(navigator.onLine); // Browser
```

### ðŸ”§ Rate limit quÃ¡ cháº·t

```typescript
const api = new AdvancedBackendService({
  baseUrl: 'https://...',
  rateLimitConfig: {
    maxRequests: 200, // TÄƒng tá»« 100
    windowMs: 60000,
  },
});
```

### ðŸ”§ Cache cÅ© Ä‘Æ°á»£c tráº£ vá»

```typescript
// VÃ´ hiá»‡u hÃ³a cache táº¡m thá»i
const api = new AdvancedBackendService({
  baseUrl: 'https://...',
  cacheConfig: {
    enableCaching: false,
  },
});

// Hoáº·c clear cache
api.clearCache();
```

### ðŸ”§ Circuit breaker má»Ÿ

```typescript
// Check status
const cb = api.getCircuitBreakerStatus();
if (cb.state === 'open') {
  console.error('Backend is down, waiting for recovery...');
  // Auto-recovers sau timeout
}
```

---

## ðŸ“š API Endpoints Reference

| Endpoint | Method | Task | Purpose |
|----------|--------|------|---------|
| `/api/ai-router` | POST | `get_user_profile` | Fetch user data |
| `/api/ai-router` | POST | `get_posts` | Query posts |
| `/api/ai-router` | POST | `generate_content` | Create educational content |
| `/api/ai-router` | POST | `admin_override_check` | Validate admin permissions |

---

## ðŸ†˜ Support & Issues

- **API Documentation:** See backend's `PRODUCTION_README.md`
- **Source Code:** Check `src/lib/api-client.ts`, `src/lib/backend-service.ts`
- **Environment Variables:** See `.env.example`
